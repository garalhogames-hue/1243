<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Player R√°dio</title>
<style>
  :root{font-family:system-ui,Segoe UI,Roboto,Arial}
  body{margin:0;background:#0f1222;color:#e9ecff;min-height:100vh;display:grid;place-items:center}
  .card{width:min(650px,92vw);background:#171a2e;border:1px solid #2a2f52;border-radius:16px;padding:24px;box-shadow:0 10px 40px rgba(0,0,0,0.4)}
  
  .header{display:flex;align-items:center;gap:20px;margin-bottom:20px}
  .avatar{width:80px;height:80px;border-radius:12px;background:#0f1230;background-size:contain;background-position:center;background-repeat:no-repeat;border:2px solid #2a2f52;image-rendering:pixelated}
  .header-info{flex:1}
  .header-info h3{margin:0 0 4px;font-size:1.25rem}
  .header-info .subtitle{opacity:.7;font-size:.875rem}
  
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0}
  .tile{background:#0f1230;border:1px solid #2a2f52;border-radius:12px;padding:14px}
  .tile.full{grid-column:1/-1}
  .label{font-size:.75rem;opacity:.7;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px}
  .value{font-weight:600;word-break:break-word;font-size:1.1rem}
  
  .controls{display:flex;gap:10px;align-items:center;margin:20px 0}
  .btn{cursor:pointer;border:0;background:#5960ff;color:#fff;padding:12px 20px;border-radius:10px;font-weight:700;transition:all 0.2s;font-size:.95rem}
  .btn:hover:not([disabled]){background:#6b71ff;transform:translateY(-1px)}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn.pause{background:#ff5960}
  .btn.pause:hover:not([disabled]){background:#ff6b71}
  
  .volume-control{flex:1;display:flex;align-items:center;gap:10px;background:#0f1230;padding:8px 12px;border-radius:10px;border:1px solid #2a2f52}
  .volume-icon{opacity:.7}
  .vol{flex:1;appearance:none;height:4px;background:#2a2f52;border-radius:2px;outline:none}
  .vol::-webkit-slider-thumb{appearance:none;width:16px;height:16px;background:#5960ff;border-radius:50%;cursor:pointer}
  .vol::-moz-range-thumb{width:16px;height:16px;background:#5960ff;border-radius:50%;cursor:pointer;border:none}
  .vol-value{min-width:35px;text-align:right;font-size:.875rem;opacity:.7}
  
  .status-bar{background:#0f1230;border:1px solid #2a2f52;border-radius:10px;padding:10px 14px;display:flex;align-items:center;gap:10px}
  .status-indicator{width:8px;height:8px;border-radius:50%;background:#ff5960;animation:pulse 2s infinite}
  .status-indicator.online{background:#5fff60}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  .status-text{font-size:.875rem;opacity:.8}
  
  .song-display{background:linear-gradient(135deg, #0f1230, #1a1f3a);border:1px solid #2a2f52;border-radius:12px;padding:16px;margin-top:12px}
  .song-label{font-size:.75rem;opacity:.7;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
  .song-text{font-size:1.05rem;font-weight:500;line-height:1.4}
</style>
</head>
<body>
  <div class="card">
    <div class="header">
      <div id="avatar" class="avatar"></div>
      <div class="header-info">
        <h3>R√°dio Online</h3>
        <div class="subtitle">24 horas de m√∫sica</div>
      </div>
    </div>

    <div class="grid">
      <div class="tile">
        <div class="label">Locutor</div>
        <div id="dj" class="value">‚Äî</div>
      </div>
      <div class="tile">
        <div class="label">Programa√ß√£o</div>
        <div id="program" class="value">‚Äî</div>
      </div>
      <div class="tile">
        <div class="label">Ouvintes</div>
        <div id="listeners" class="value">‚Äî</div>
      </div>
      <div class="tile">
        <div class="label">Status</div>
        <div id="status" class="value">‚Äî</div>
      </div>
    </div>

    <div class="song-display">
      <div class="song-label">Tocando agora</div>
      <div id="song" class="song-text">‚Äî</div>
    </div>

    <div class="controls">
      <button id="playBtn" class="btn">‚ñ∂Ô∏è Tocar</button>
      <button id="pauseBtn" class="btn pause" disabled>‚è∏Ô∏è Pausar</button>
      <div class="volume-control">
        <span class="volume-icon">üîä</span>
        <input id="volume" class="vol" type="range" min="0" max="100" value="80">
        <span id="volValue" class="vol-value">80%</span>
      </div>
    </div>

    <div class="status-bar">
      <div id="statusIndicator" class="status-indicator"></div>
      <div id="statusText" class="status-text">Desconectado</div>
    </div>

    <audio id="radio" preload="none" playsinline></audio>
  </div>

<script>
  // ====== CONFIGURA√á√ïES ======
  const STREAM_URL = "http://sonicpanel.oficialserver.com:8342/;mp3";
  const STATUS_ENDPOINT = "./status.php";
  const AVATAR_TEMPLATE = "https://habblive.in/imager.php?user=%username%&action=drk=667&size=l&head_direction=3&direction=4&gesture=spk&headonly=1";
  const DEFAULT_AVATAR_USER = "Blume"; // Avatar padr√£o para AutoDJ
  
  // ====== ELEMENTOS DOM ======
  const audio = document.getElementById("radio");
  const playBtn = document.getElementById("playBtn");
  const pauseBtn = document.getElementById("pauseBtn");
  const vol = document.getElementById("volume");
  const volValue = document.getElementById("volValue");
  const elDj = document.getElementById("dj");
  const elProgram = document.getElementById("program");
  const elListeners = document.getElementById("listeners");
  const elSong = document.getElementById("song");
  const elStatus = document.getElementById("status");
  const elAvatar = document.getElementById("avatar");
  const statusIndicator = document.getElementById("statusIndicator");
  const statusText = document.getElementById("statusText");

  // ====== CONTROLE DE VOLUME ======
  audio.volume = Number(vol.value)/100;
  vol.addEventListener("input", () => {
    const value = Number(vol.value);
    audio.volume = value/100;
    volValue.textContent = value + "%";
  });

  // ====== CONTROLE DE √ÅUDIO ======
  function resetAudio(){
    audio.pause();
    audio.src = "";
    audio.load();
  }

  function playLive(){
    resetAudio();
    audio.src = STREAM_URL + "?t=" + Date.now();
    audio.load();
    audio.play().then(() => {
      playBtn.disabled = true;
      pauseBtn.disabled = false;
      statusIndicator.classList.add("online");
      statusText.textContent = "Conectado e tocando";
    }).catch(err => {
      statusText.textContent = "Erro ao conectar - clique para tentar novamente";
      playBtn.disabled = false;
      pauseBtn.disabled = true;
      statusIndicator.classList.remove("online");
    });
  }

  function pauseLive(){
    resetAudio();
    playBtn.disabled = false;
    pauseBtn.disabled = true;
    statusIndicator.classList.remove("online");
    statusText.textContent = "Pausado";
  }

  playBtn.addEventListener("click", playLive);
  pauseBtn.addEventListener("click", pauseLive);

  // ====== DETEC√á√ÉO DE AUTODJ ======
  function isAutoDJ(djName) {
    if (!djName || djName === "‚Äî" || djName === "") return true;
    
    // Padr√µes que indicam AutoDJ (case insensitive)
    const autoDJPatterns = [
      "autodj",
      "auto dj",
      "auto-dj",
      "radio habblive",
      "habblive",
      "blume",
      "radiobot",
      "bot",
      "automatic",
      "autom√°tico",
      "autom√°tico dj"
    ];
    
    const djLower = djName.toLowerCase().trim();
    
    // Verifica se o nome cont√©m algum dos padr√µes
    return autoDJPatterns.some(pattern => {
      // Verifica correspond√™ncia exata
      if (djLower === pattern) return true;
      // Verifica se cont√©m o padr√£o
      if (djLower.includes(pattern)) return true;
      return false;
    });
  }

  // ====== ATUALIZA√á√ÉO DE AVATAR ======
  function updateAvatar(djName, isAuto) {
    if (!AVATAR_TEMPLATE) return;
    
    let username = DEFAULT_AVATAR_USER;
    
    if (!isAuto && djName) {
      // Usa o nome do locutor diretamente, sem substituir espa√ßos
      username = djName.trim();
    }
    
    const avatarUrl = AVATAR_TEMPLATE.replace("%username%", encodeURIComponent(username));
    elAvatar.style.backgroundImage = `url(${avatarUrl})`;
    
    // Adiciona tratamento de erro para imagem n√£o encontrada
    const img = new Image();
    img.onerror = function() {
      // Se falhar ao carregar o avatar do locutor, usa o padr√£o
      const fallbackUrl = AVATAR_TEMPLATE.replace("%username%", encodeURIComponent(DEFAULT_AVATAR_USER));
      elAvatar.style.backgroundImage = `url(${fallbackUrl})`;
    };
    img.src = avatarUrl;
  }

  // ====== BUSCA DE STATUS ======
  const lastData = { 
    dj: null, 
    program: null, 
    listeners: null, 
    song: null,
    serverUp: true 
  };
  
  async function fetchStatus(){
    try {
      const response = await fetch(STATUS_ENDPOINT + "?ts=" + Date.now(), { 
        cache: "no-store",
        headers: {
          'Accept': 'application/json',
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (data && data.ok !== false) {
        // Atualiza os dados recebidos
        if (data.dj !== null && data.dj !== undefined) {
          lastData.dj = data.dj;
        }
        if (data.program !== null && data.program !== undefined) {
          lastData.program = data.program;
        }
        if (Number.isFinite(data.listeners)) {
          lastData.listeners = data.listeners;
        }
        if (data.song !== null && data.song !== undefined) {
          lastData.song = data.song;
        }
        if (data.serverUp !== undefined) {
          lastData.serverUp = data.serverUp;
        }
        
        // Processa o nome do DJ
        let displayDJ = "AutoDJ";
        let displayProgram = "Tocando as melhores!";
        let isAuto = true;
        
        // Verifica se tem um DJ real (n√£o AutoDJ)
        if (lastData.dj && lastData.dj.trim() !== "") {
          const djName = lastData.dj.trim();
          
          if (!isAutoDJ(djName)) {
            // √â um locutor real
            displayDJ = djName;
            displayProgram = lastData.program || "Programa ao vivo";
            isAuto = false;
          }
        }
        
        // Atualiza a interface
        elDj.textContent = displayDJ;
        elProgram.textContent = displayProgram;
        elListeners.textContent = lastData.listeners !== null ? lastData.listeners : "0";
        elSong.textContent = lastData.song || "‚Äî";
        
        // Atualiza o avatar
        updateAvatar(displayDJ, isAuto);
        
        // Status do servidor
        if (lastData.serverUp) {
          elStatus.textContent = "Online";
          elStatus.style.color = "#5fff60";
        } else {
          elStatus.textContent = "Offline";
          elStatus.style.color = "#ff5960";
          statusText.textContent = "Servidor offline";
        }
        
      }
    } catch(error) {
      console.error("Erro ao buscar status:", error);
      elStatus.textContent = "Erro";
      elStatus.style.color = "#ff5960";
    }
  }
  
  // ====== INICIALIZA√á√ÉO ======
  fetchStatus();
  setInterval(fetchStatus, 8000); // Atualiza a cada 8 segundos como no script.js original
  
  // Status inicial
  statusText.textContent = "Pronto para tocar";
</script>
</body>
</html>